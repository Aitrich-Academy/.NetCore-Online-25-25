CREATE TABLE Employeess (
    EmpID INT PRIMARY KEY IDENTITY(1,1),
    FirstName NVARCHAR(50),
    LastName NVARCHAR(50),
    Department NVARCHAR(30),
    Salary DECIMAL(10,2),
    JoinDate DATE
);

CREATE TABLE SalaryAudit (
    AuditID INT PRIMARY KEY IDENTITY(1,1),
    EmpID INT,
    OldSalary DECIMAL(10,2),
    NewSalary DECIMAL(10,2),
    ChangeDate DATETIME DEFAULT GETDATE()
);

CREATE TABLE DeletedEmployeess (
    DelEmpID INT,
    EmpName NVARCHAR(100),
    DeletedOn DATETIME DEFAULT GETDATE()
);
Step 1: Insert Sample Data

INSERT INTO Employeess (FirstName, LastName, Department, Salary, JoinDate)
VALUES
('John', 'Doe', 'IT', 40000, '2020-01-15'),
('Anita', 'Rao', 'Finance', 65000, '2019-03-10'),
('Ravi', 'Sharma', 'HR', 42000, '2021-06-20'),
('Sara', 'Khan', 'IT', 75000, '2018-11-12'),
('Meena', 'Joshi', 'Finance', 50000, '2022-04-01');

select * from Employeess

CREATE FUNCTION dbo.fn_AnnualSalary(@EmpID INT)
RETURNS DECIMAL(10,2)
AS
BEGIN
    DECLARE @AnnualSalary DECIMAL(10,2);
    SELECT @AnnualSalary  = Salary * 12
    FROM Employeess
    WHERE EmpID = @EmpID;
    RETURN  @AnnualSalary
    END;

SELECT dbo.fn_AnnualSalary(1) AS AnnualSalary;


SELECT 
    FirstName + ' ' + LastName AS EmployeeName,
    dbo.fn_AnnualSalary(EmpID) AS AnnualSalary
FROM Employeess;


CREATE FUNCTION dbo.fn_FullName(@EmpID INT)
RETURNS NVARCHAR(100)
AS
BEGIN
    DECLARE @FullName NVARCHAR(100);
    SELECT @FullName = FirstName + '' + LastName
    FROM Employeess
    WHERE EmpID = @EmpID;
    RETURN @FullName;
END;


SELECT dbo.fn_FullName(EmpID)
FROM Employeess;


CREATE FUNCTION dbo.fn_EmployeesByDept(@Dept NVARCHAR(30))
RETURNS TABLE
AS
RETURN
    (
       SELECT EmpID,FirstName,LastName,Department,Salary,JoinDate
       FROM Employeess
       WHERE Department = @Dept 
    );

  -- IT Department
SELECT * FROM dbo.fn_EmployeesByDept('IT');

-- Finance Department
SELECT * FROM dbo.fn_EmployeesByDept('Finance');
  

CREATE FUNCTION dbo.fn_DeptSalarySummary()
RETURNS @DeptSummary TABLE
(
    Department NVARCHAR(30),
    TotalSalary DECIMAL(10,2),
    EmployeeCount INT,
    AverageSalary DECIMAL(10,2)

)
AS
BEGIN
    INSERT INTO @DeptSummary
    SELECT Department,
           SUM(Salary) AS TotalSalary,
           COUNT(*) AS EmployeeCount,
           AVG(Salary) AS AverageSalary
    FROM Employeess
    GROUP BY Department;

    RETURN;
END;

SELECT * FROM dbo.fn_DeptSalarySummary();



CREATE FUNCTION dbo.fn_SalaryGrade(@Salary DECIMAL(10,2))
RETURNS CHAR(1)
AS
BEGIN
    DECLARE @Grade CHAR(1);

    IF @Salary > 70000
        SET @Grade = 'A';
    ELSE IF @Salary >= 50000
        SET @Grade = 'B';
    ELSE
        SET @Grade = 'C';
RETURN @Grade;

END;


SELECT FirstName + ' ' + LastName AS EmployeesName,
       Salary,
       dbo.fn_SalaryGrade(Salary) AS Grade
FROM Employeess;



--TRIGGER ACTIVITIES

CREATE TRIGGER trg_NewEmployeeInsert
ON EmployeesS
AFTER INSERT
AS
BEGIN
    DECLARE @FullName NVARCHAR(100), @Dept NVARCHAR(30);

    SELECT @FullName = FirstName + ' ' + LastName,
           @Dept = Department
    FROM inserted;

    PRINT 'New employee ' + @FullName + ' added to the ' + @Dept + ' department.';
END;

INSERT INTO Employeess (FirstName, LastName, Department, Salary, JoinDate)
VALUES ('Test', 'User', 'IT', 45000, '2025-10-15');




CREATE TRIGGER trg_SalaryUpdate
ON Employeess
AFTER UPDATE
AS
BEGIN
    INSERT INTO SalaryAudit (EmpID,OldSalary,NewSalary)
    SELECT d.EmpID,d.Salary,i.Salary
    FROM deleted d
    INNER JOIN inserted i ON d.EmpID = i.EmpID
    WHERE d.Salary <> i.Salary;
END;

UPDATE Employeess
SET Salary = 70000
WHERE EmpID = 1;
SELECT * FROM SalaryAudit;


SELECT * from SalaryAudit


CREATE TRIGGER trg_NewEmployeeInsert2
ON Employeess
After Insert
AS
BEGIN
  -- Declare variables to store values from 'inserted' table 
  DECLARE @FullName NVARCHAR(100) ;
  DECLARE @Dept NVARCHAR(30);

     -- Get data of the newly inserted row
     SELECT
        @FullName = FirstName + '' + LastName,
        @Dept = Department
    FROM inserted;

        -- Print message
    PRINT 'New employee ' + @FullName + ' added to the ' + @Dept + ' department.';
END;

INSERT INTO Employeess (FirstName, LastName, Department, Salary, JoinDate)
VALUES ('Kiran', 'Patel', 'IT', 55000, '2025-01-10');

SELECT * from Employeess


CREATE trg_SalaryUpdate
ON Employeess
After UPDATE
As 
BEGIN


--insert old and newsalry into salaryAudit table
INSERT INTO SalaryAudit (EmpID, OldSalary, NewSalary)
    SELECT d.EmpID, d.Salary, i.Salary
    FROM deleted d
    INNER JOIN inserted i ON d.EmpID = i.EmpID
    WHERE d.Salary <> i.Salary;  -- Only if salary changed
END;


-- Update an employee salary
UPDATE Employees
SET Salary = 60000
WHERE EmpID = 1;

-- Check SalaryAudit table
SELECT * FROM SalaryAudit;












